<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>双Y轴(合并Tooltip)示例</title>

  <!-- Papa Parse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.2.1"></script>

  <style>
    html, body {
      margin:0; 
      padding:0;
      font-family: sans-serif;
      overflow-y: auto; /* 允许上下滚动 */
    }
    .container {
      width:100%;
      max-width:1600px;
      margin:0 auto;
      padding:10px;
    }
    .controlBar {
      margin-bottom:10px;
    }
    .chartBox {
      border:1px solid #ccc;
      margin-bottom:20px;
      padding:10px;
    }
    #myChart {
      width:100%;
      height:700px;
      background:#fff;
    }
    /* 侧边栏(仅关键词用) */
    .sidebar-toggle {
      background:#3b5998;
      color:#fff;
      padding:6px 10px;
      border:none;
      cursor:pointer;
      margin-right:8px;
    }
    .sidebarKw {
      position:absolute;
      top:140px;
      left:20px;
      width:250px; 
      height:400px;
      background:#fafafa;
      box-shadow:2px 2px 5px rgba(0,0,0,0.2);
      transform:translateX(-300%);
      transition:0.3s;
      overflow-y:auto;
      padding:10px;
      box-sizing:border-box;
      z-index:9999;
    }
    .sidebarKw.active {
      transform:translateX(0);
    }
    .sidebarKw h3 {
      margin-top:0; 
      margin-bottom:6px;
      display:flex; 
      align-items:center;
      gap:4px;
    }
    .group-panel {
      margin-bottom:6px;
      border:1px solid #ccc;
      border-radius:4px;
    }
    summary {
      background:#eee;
      padding:4px 6px;
      font-weight:bold;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    summary button {
      font-size:12px;
      margin-left:8px;
      cursor:pointer;
    }
  </style>
</head>
<body>

<div class="container">

  <h1>双Y轴(左:关键词排名 右:气温) + 合并Tooltip示例</h1>

  <div class="controlBar">
    <button class="sidebar-toggle" id="toggleSidebarKw">≡ 分组</button>
    <button id="btnRefresh">刷新数据</button>

    <label>开始周:</label>
    <select id="startWeek"></select>
    <label>结束周:</label>
    <select id="endWeek"></select>
    <button id="btnFilter">更新区间</button>
  </div>

  <!-- 侧边栏: 关键词分组折叠 -->
  <div class="sidebarKw" id="sidebarKw">
    <h3>分组
      <button id="btnKwAll">全选</button>
      <button id="btnKwNone">全不选</button>
    </h3>
    <div id="groupContainerKw"></div>
  </div>

  <div class="chartBox">
    <canvas id="myChart"></canvas>
  </div>
</div>

<script>
/***************************************************************
 * 1. 三个CSV: 关键词(宽表), 平均气温, 最高气温
 ***************************************************************/
const KW_CSV_URL   = "https://docs.google.com/spreadsheets/d/e/.../pub?output=csv";
const AVG_CSV_URL  = "https://docs.google.com/spreadsheets/d/e/.../pub?output=csv";
const MAX_CSV_URL  = "https://docs.google.com/spreadsheets/d/e/.../pub?output=csv";

/***************************************************************
 * 2. Papa Parse
 ***************************************************************/
function parseCSV(url){
  return new Promise((resolve, reject)=>{
    Papa.parse(url, {
      download:true,
      complete: res => resolve(res.data),
      error: err => reject(err)
    });
  });
}

/***************************************************************
 * 3. 全局结构
 ***************************************************************/
let allWeeks = [];  // X轴: union(关键词+气温) 
// 关键词 => group=> {keyword=>[]}
let kwGroups= {};
// 氣温 => arrAvg, arrMax
let arrAvg= [];
let arrMax= [];

/***************************************************************
 * 4. 载入关键词(宽表->长表->分组)
 ***************************************************************/
async function loadKeywords(){
  const raw= await parseCSV(KW_CSV_URL);
  // row0 => group, row1=>keyword, row2+ => fileName+data
  let longData=[];
  const rowGrp= raw[0];
  const rowKw = raw[1];
  for(let r=2; r< raw.length; r++){
    const row= raw[r];
    const fn= row[0];
    for(let c=1; c< row.length; c++){
      const grp= rowGrp[c];
      const k  = rowKw[c];
      const val= Number(row[c]||0);
      longData.push({fn,grp,k,val});
    }
  }
  // union weeks
  let setW= new Set(allWeeks);
  longData.forEach(it=> setW.add(it.fn));
  allWeeks= Array.from(setW).sort();

  // group => {k=> array}
  let gData={};
  let count= allWeeks.length;
  longData.forEach(it=>{
    const f= it.fn;
    const g= it.grp;
    const k= it.k;
    const v= it.val;
    if(!gData[g]) gData[g]={};
    if(!gData[g][k]) gData[g][k]= new Array(count).fill(NaN);
    let idx= allWeeks.indexOf(f);
    gData[g][k][idx]= v;
  });
  // sort
  let sorted={};
  Object.keys(gData).sort().forEach(grp=>{
    let kwMap= gData[grp];
    let sortedKw={};
    Object.keys(kwMap).sort().forEach(k=>{
      sortedKw[k]= kwMap[k];
    });
    sorted[grp]= sortedKw;
  });
  kwGroups= sorted;
}

/***************************************************************
 * 5. 载入气温(平均/最高)
 ***************************************************************/
async function loadTemperature(){
  const rawAvg= await parseCSV(AVG_CSV_URL);
  // row0 => [ "fileName","avg" ]
  let mapAvg= {};
  for(let r=1; r< rawAvg.length; r++){
    const row= rawAvg[r];
    const fn= row[0];
    const val= Number(row[1]||0);
    mapAvg[fn]= val;
  }
  const rawMax= await parseCSV(MAX_CSV_URL);
  let mapMax= {};
  for(let r=1; r< rawMax.length; r++){
    const row= rawMax[r];
    const fn= row[0];
    const val= Number(row[1]||0);
    mapMax[fn]= val;
  }

  // union weeks
  let setW= new Set(allWeeks);
  Object.keys(mapAvg).forEach(fn=> setW.add(fn));
  Object.keys(mapMax).forEach(fn=> setW.add(fn));
  allWeeks= Array.from(setW).sort();

  arrAvg= new Array(allWeeks.length).fill(NaN);
  arrMax= new Array(allWeeks.length).fill(NaN);
  allWeeks.forEach((fn,i)=>{
    if(fn in mapAvg) arrAvg[i]= mapAvg[fn];
    if(fn in mapMax) arrMax[i]= mapMax[fn];
  });
}

/***************************************************************
 * 6. 构造 datasets (关键词 + 氣温)
 *    关键词 => yAxisID:'yKw' (reverse)
 *    氣温 => yAxisID:'yTemp' (normal)
 ***************************************************************/
function buildDatasets(){
  let dsList=[];
  // 关键词(从 sidebar checked 里获取)
  const cbs= document.querySelectorAll(`#groupContainerKw input[type='checkbox']:checked`);
  const colorList=[
    "#e6194b","#3cb44b","#ffe119","#0082c8","#f58231","#911eb4","#46f0f0",
    "#f032e6","#d2f53c","#fabebe","#008080","#e6beff","#aa6e28","#fffac8",
    "#800000","#aaffc3","#808000","#ffd8b1","#000080","#808080","#000000"
  ];
  let idx=0;
  cbs.forEach(cb=>{
    const g= cb.dataset.group;
    const k= cb.dataset.keyword;
    dsList.push({
      label: g+"/"+k,
      data: kwGroups[g][k],
      borderColor: colorList[idx%colorList.length],
      fill:false,
      tension:0.1,
      pointRadius:2,
      yAxisID: 'yKw'
    });
    idx++;
  });

  // 氣温(固定2条: 平均, 最高)
  dsList.push({
    label:"平均气温",
    data: arrAvg,
    borderColor:"blue",
    fill:false,
    tension:0.1,
    pointRadius:2,
    yAxisID:'yTemp'
  });
  dsList.push({
    label:"最高气温",
    data: arrMax,
    borderColor:"red",
    fill:false,
    tension:0.1,
    pointRadius:2,
    yAxisID:'yTemp'
  });

  return dsList;
}

/***************************************************************
 * 7. 创建图 (合并Tooltip)
 ***************************************************************/
let chartObj;
function renderChart(weeks, ds){
  const ctx= document.getElementById("myChart").getContext("2d");
  if(chartObj) chartObj.destroy();

  chartObj= new Chart(ctx, {
    type:'line',
    data:{
      labels: weeks,
      datasets: ds
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      // 关键: 让Tooltip在同xindex合并
      interaction:{
        mode:'index',
        intersect:false
      },
      scales:{
        x:{
          title:{display:true,text:"周"},
          ticks:{
            autoSkip:false, maxRotation:45, minRotation:45,
            color:"#333", font:{size:14}
          }
        },
        yKw:{
          type:'linear',
          position:'left',
          reverse:true, // 排名小值在上
          ticks:{
            color:"#333",font:{size:14},
            callback:function(value){
              if(value>=1000) return (value/1000)+"k";
              return value;
            }
          }
        },
        yTemp:{
          type:'linear',
          position:'right',
          reverse:false, // 氣温正常坐标
          grid:{ drawOnChartArea:false }, // 不绘制网格以免重叠
          ticks:{
            color:"#d33", font:{size:14},
            callback:function(v){
              return v.toFixed(2)+"°C";
            }
          }
        }
      },
      plugins:{
        tooltip:{
          // single tooltip merges all lines
          callbacks:{
            label:function(context){
              const dsLabel= context.dataset.label;
              const val= context.parsed.y;
              if(dsLabel.includes("气温")){
                return dsLabel+": "+ val.toFixed(2)+"°C";
              } else {
                // 关键词ranking
                return dsLabel+": "+ val;
              }
            }
          }
        }
      }
    }
  });
}

/***************************************************************
 * 8. 切片(区间筛选)
 ***************************************************************/
function filterRange(startIdx, endIdx){
  const dsFull= buildDatasets();
  // slice each data
  const dsSliced= dsFull.map(one=>{
    const sub= one.data.slice(startIdx,endIdx+1);
    return {...one, data: sub};
  });
  const subWeeks= allWeeks.slice(startIdx,endIdx+1);
  renderChart(subWeeks, dsSliced);
}

/***************************************************************
 * 侧边栏(关键词)
 ***************************************************************/
function renderSidebarKw(){
  const container= document.getElementById("groupContainerKw");
  container.innerHTML="";
  Object.keys(kwGroups).forEach(g=>{
    const details= document.createElement("details");
    details.className="group-panel";

    const summary= document.createElement("summary");
    const sumSpan= document.createElement("span");
    sumSpan.textContent= g;
    summary.appendChild(sumSpan);

    // group-level all/none
    const allBtn= document.createElement("button");
    allBtn.textContent="全选";
    allBtn.style.fontSize="12px";
    allBtn.addEventListener("click",(e)=>{
      e.stopPropagation();
      setGroupCheckKw(g,true);
    });
    summary.appendChild(allBtn);

    const noneBtn= document.createElement("button");
    noneBtn.textContent="全不选";
    noneBtn.style.fontSize="12px";
    noneBtn.addEventListener("click",(e)=>{
      e.stopPropagation();
      setGroupCheckKw(g,false);
    });
    summary.appendChild(noneBtn);

    details.appendChild(summary);

    const kwMap= kwGroups[g];
    Object.keys(kwMap).forEach(k=>{
      const lb= document.createElement("label");
      lb.style.display="block";
      const cb= document.createElement("input");
      cb.type="checkbox";
      cb.checked=true;
      cb.dataset.group= g;
      cb.dataset.keyword= k;
      lb.appendChild(cb);
      lb.append(" "+k);
      details.appendChild(lb);
    });

    container.appendChild(details);
  });

  container.addEventListener("change",(e)=>{
    if(e.target.type==="checkbox"){
      const ds= buildDatasets();
      renderChart(allWeeks, ds);
    }
  });
}

function setGroupCheckKw(grp, isCheck){
  const cbs= document.querySelectorAll(`#groupContainerKw input[data-group="${grp}"]`);
  cbs.forEach(cb=> cb.checked=isCheck);
  const ds= buildDatasets();
  renderChart(allWeeks, ds);
}
function setAllCheckKw(isCheck){
  const cbs= document.querySelectorAll(`#groupContainerKw input[type='checkbox']`);
  cbs.forEach(cb=> cb.checked=isCheck);
  const ds= buildDatasets();
  renderChart(allWeeks, ds);
}

/***************************************************************
 * 入口
 ***************************************************************/
async function main(){
  // 1) 加载关键词
  await loadKeywords();
  // 2) 加载气温
  await loadTemperature();
  // 3) 渲染 sidebar
  renderSidebarKw();
  // 4) init下拉
  const startSel= document.getElementById("startWeek");
  const endSel  = document.getElementById("endWeek");
  startSel.innerHTML="";
  endSel.innerHTML="";
  allWeeks.forEach((wk,i)=>{
    const o1= document.createElement("option");
    o1.value= i;
    o1.text= wk.replace("_Week_"," W");
    startSel.appendChild(o1);

    const o2= document.createElement("option");
    o2.value= i;
    o2.text= wk.replace("_Week_"," W");
    endSel.appendChild(o2);
  });
  startSel.value=0;
  endSel.value= allWeeks.length-1;

  // 5) 默认 => buildDatasets => render
  const ds= buildDatasets();
  renderChart(allWeeks, ds);
}

/***************************************************************
 * 事件
 ***************************************************************/
document.getElementById("toggleSidebar").addEventListener("click",()=>{
  document.getElementById("sidebarKw").classList.toggle("active");
});
document.getElementById("btnRefresh").addEventListener("click",()=>{
  main();
});
document.getElementById("btnFilter").addEventListener("click",()=>{
  const s= parseInt(document.getElementById("startWeek").value);
  const e= parseInt(document.getElementById("endWeek").value);
  const startIdx= Math.min(s,e);
  const endIdx= Math.max(s,e);
  filterRange(startIdx,endIdx);
});
document.getElementById("btnKwAll").addEventListener("click",()=>{
  setAllCheckKw(true);
});
document.getElementById("btnKwNone").addEventListener("click",()=>{
  setAllCheckKw(false);
});

// onload
window.onload= ()=>{
  main().catch(err=>console.error("main error:", err));
};
</script>

</body>
</html>
