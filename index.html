<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>KeyWord热度 + 氣温 + 搜索 + 最近一周(排序) + 重试</title>

  <!-- Papa Parse (解析CSV) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <!-- Chart.js（保持你原来的版本；已含 decimation 插件） -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.2.1"></script>

  <style>
    :root{
      --bg:#0c0f14;--panel:#0f1117;--border:#1f2937;--fg:#e5e7eb;--muted:#93a3b8;
    }
    html, body {
      margin: 0; padding: 0; height: 100%;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans SC","Noto Sans JP",sans-serif;
      overflow: auto; background: var(--bg); color: var(--fg);
    }

    /* 顶部按钮 */
    .sidebar-toggle {
      position: fixed; left: 10px; bottom: 14px;
      background: #1f2937; color: #fff;
      padding: 10px 12px; border: 1px solid var(--border);
      border-radius: 999px; cursor: pointer; z-index: 9999;
    }

    /* 侧边栏 */
    .sidebar {
      position: fixed; left: 0; top: 0;
      width: 280px; height: 100vh;
      background: var(--panel);
      border-right: 1px solid var(--border);
      transform: translateX(0);
      transition: transform 0.3s;
      padding: 12px; padding-top: 64px;
      box-sizing: border-box; overflow-y: auto; z-index: 9998;
    }
    .sidebar.hidden { transform: translateX(-100%); }
    .sidebar h3 {
      margin: 0 0 10px 0; display: flex; align-items: center; gap: 8px; font-size: 15px;
    }
    .search-row { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; }
    .search-row input, .search-row button {
      background:#0b0c10; color: var(--fg); border:1px solid var(--border); border-radius:10px; padding:8px 10px;
    }
    .group-panel {
      margin-bottom: 10px; border: 1px solid var(--border); border-radius: 12px; overflow: hidden;
    }
    summary {
      background: #0c111a; padding: 8px 12px; font-weight: 600; cursor: pointer;
      display: flex; align-items: center; justify-content: space-between;
    }
    summary button {
      font-size: 12px; cursor: pointer; margin-left: 6px;
      background:#0b0c10; color: var(--fg); border:1px solid var(--border); border-radius: 8px; padding:4px 8px;
    }
    label { display: block; padding: 4px 12px; color:#cfd8e3; }
    #noMatchMsg { display: none; color: var(--muted); margin-top: 8px; }

    /* 主区域 */
    .main-area {
      margin-left: 280px; display: flex; flex-direction: column; height: 100vh;
    }
    @media (max-width: 1100px) { .main-area { margin-left: 0; } }

    .topbar {
      position: sticky; top: 0; z-index: 10;
      background: var(--panel); border-bottom: 1px solid var(--border);
      padding: 10px 12px; display: flex; align-items: center; gap: 8px; flex-shrink: 0;
    }
    .topbar h1 { margin:0; flex:1; font-size:18px; color:#f3f4f6 }
    .topbar select, .topbar button, .topbar label {
      background:#0b0c10; color: var(--fg); border:1px solid var(--border); border-radius:10px; padding:8px 10px;
    }
    .topbar label { background: transparent; border: none; color: var(--muted); padding: 0; }

    .chart-container {
      flex: 1; position: relative; overflow: auto; background: var(--panel); border-top: 1px solid var(--border);
    }
    #myChart { min-width: 1200px; height: 640px; }
  </style>
</head>

<body>
  <!-- 移动端快捷隐藏侧栏 -->
  <button class="sidebar-toggle" id="toggleSidebar">≡ 侧栏</button>

  <!-- 侧边栏 -->
  <div class="sidebar" id="sidebar">
    <h3>
      分组
      <button id="globalAllBtn">全选</button>
      <button id="globalNoneBtn">全不选</button>
    </h3>

    <!-- 搜索框 -->
    <div class="search-row">
      <input type="text" id="searchInput" placeholder="搜索分组或关键词...">
      <button id="btnClearSearch">清空</button>
    </div>

    <div id="groupContainer"></div>
    <div id="noMatchMsg">未找到匹配项</div>
  </div>

  <div class="main-area">
    <div class="topbar">
      <h1>KeyWord热度 + 氣温 + 搜索 + 最近一周(排序) + 重试</h1>
      <button id="btnRefresh">刷新数据</button>
      <label>开始周:</label>
      <select id="startWeek"></select>
      <label>结束周:</label>
      <select id="endWeek"></select>
      <button id="btnFilter">更新区间</button>
    </div>

    <div class="chart-container">
      <canvas id="myChart"></canvas>
    </div>
  </div>

<script>
/***************************************************************
 * 1) CSV链接（保留你的 Google 表格发布地址）
 ***************************************************************/
const KEYWORD_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTxT7pk3XLnPr87Fpq2Fii90bqh_R2jsCjO6e3dZkMLKmuw75ksYiuSce3DC7uUK5IXBEFmeKT1P7oJ/pub?output=csv";
const AVG_TEMP_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQsIu0jYheUb5YE9-D0SwtL6FxkTjFwEgWaH56NdOyqYfNkcZLJGM2xp9T2wPLcF5lYFBZ3UCa7eiaj/pub?output=csv";
const MAX_TEMP_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSnxZTyYhuMkeM0D0ystDYz2w0tQJZDN5yyxoy51Rl8yA23j-7nSm3gOC4SeAJnhB9_iHT_mTIVzZlR/pub?output=csv";

/***************************************************************
 * 2) 全局变量
 ***************************************************************/
let chart;
let labelsAll = [];
let groupsData = {};      // 当前显示的分组/关键词数据
let globalGroupsRaw = {}; // 原始分组数据，用于搜索还原
let tempAvgData = [];
let tempMaxData = [];

/***************************************************************
 * 3) 工具：HSL 等角配色（无限条也不乱）
 ***************************************************************/
function colorAt(i) {
  const hue = (i * 37) % 360;              // 37°步进避免相近色
  return `hsl(${hue} 70% 55%)`;
}

/***************************************************************
 * 4) 工具：重试拉取 CSV（只保留一份，修复你原来的重复定义）
 ***************************************************************/
function parseCSVWithRetry(url, maxAttempts = 3) {
  return new Promise((resolve, reject) => {
    let attempts = 0;
    function attemptFetch() {
      attempts++;
      Papa.parse(url, {
        download: true,
        complete: res => resolve(res),
        error: err => {
          console.warn(`[WARN] 第${attempts}次请求失败:`, err);
          if (attempts < maxAttempts) attemptFetch(); else reject(err);
        }
      });
    }
    attemptFetch();
  });
}

/***************************************************************
 * 5) A. 加载&解析 关键词 CSV
 ***************************************************************/
function convertWideToLong(raw2D) {
  // 第0行：分组；第1行：关键词；第2行起：每列对应周的值
  const rowGroup = raw2D[0];
  const rowKeyword = raw2D[1];
  const out = [];
  for (let r = 2; r < raw2D.length; r++) {
    const row = raw2D[r];
    if (!row[0]) continue;
    const fileName = row[0];
    for (let c = 1; c < row.length; c++) {
      const grp = rowGroup[c];
      const kw = rowKeyword[c];
      const val = parseFloat(row[c] || 0);
      out.push({ week_label: fileName, group: grp, keyword: kw, value: val });
    }
  }
  return out;
}

function processLongRows(longData) {
  const setWeeks = new Set();
  longData.forEach(it => setWeeks.add(it.week_label));
  const weeks = Array.from(setWeeks).sort();

  const gData = {};
  const count = weeks.length;
  longData.forEach(it => {
    const w = it.week_label;
    const g = it.group;
    const k = it.keyword;
    const v = it.value;
    if (!gData[g]) gData[g] = {};
    if (!gData[g][k]) gData[g][k] = new Array(count).fill(NaN);
    const idx = weeks.indexOf(w);
    gData[g][k][idx] = v;
  });

  const sorted = {};
  Object.keys(gData).sort().forEach(gName => {
    const kwMap = gData[gName];
    const sortedKwMap = {};
    Object.keys(kwMap).sort().forEach(kName => {
      sortedKwMap[kName] = kwMap[kName];
    });
    sorted[gName] = sortedKwMap;
  });
  return { weeks, groups: sorted };
}

/***************************************************************
 * 6) B. 加载&解析 氣温 CSV
 ***************************************************************/
function convertTempData(raw2D) {
  // 第0行=标题, 第1行起 => [week_label, value]
  const map = {};
  for (let r = 1; r < raw2D.length; r++) {
    const row = raw2D[r];
    if (!row[0]) continue;
    const wk = row[0];
    const val = parseFloat(row[1] || 0);
    map[wk] = val;
  }
  return map;
}

/***************************************************************
 * 7) C. createChart：单图 + 左轴(关键词) + 右轴(气温)
 *    —— 仅优化了配置：抽样/无动画/淡网格/更清晰线型
 ***************************************************************/
function createChart(weeks, dsList) {
  const ctx = document.getElementById("myChart").getContext("2d");
  if (chart) chart.destroy();

  // 右轴：气温（虚线）
  dsList.push({
    label: "平均气温",
    data: tempAvgData,
    borderColor: "rgba(99,162,255,.9)",
    borderWidth: 2,
    borderDash: [6, 3],
    fill: false,
    tension: 0.25,
    pointRadius: 0,
    yAxisID: "y2"
  });
  dsList.push({
    label: "最高气温",
    data: tempMaxData,
    borderColor: "rgba(255,120,120,.95)",
    borderWidth: 2,
    borderDash: [6, 3],
    fill: false,
    tension: 0.25,
    pointRadius: 0,
    yAxisID: "y2"
  });

  chart = new Chart(ctx, {
    type: "line",
    data: { labels: weeks, datasets: dsList },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      normalized: true,
      parsing: false,
      animation: false,
      interaction: { mode: 'index', intersect: false },
      elements: { line: { capBezierPoints: true } },
      scales: {
        x: {
          title: { display: true, text: "周" },
          grid: { color: 'rgba(255,255,255,0.08)' },
          ticks: { color: '#9ca3af', maxRotation: 0, autoSkip: true }
        },
        y: {
          reverse: true,
          title: { display: true, text: "关键词热度(数值小→上)" },
          grid: { color: 'rgba(255,255,255,0.08)' },
          ticks: { color: '#9ca3af' }
        },
        y2: {
          type: "linear",
          position: "right",
          reverse: false,
          title: { display: true, text: "气温(℃)" },
          grid: { drawOnChartArea: false },
          ticks: { color: '#9ca3af' }
        }
      },
      plugins: {
        legend: { labels: { font: { size: 12 }, boxWidth: 10, color: '#d1d5db' } },
        decimation: { enabled: true, algorithm: 'min-max', samples: 300 },
        tooltip: {
          titleFont: { size: 13 },
          bodyFont: { size: 12 },
          callbacks: {
            label: function (context) {
              const val = context.parsed.y;
              let str = context.dataset.label + ": " + val;
              if (context.dataset.yAxisID === "y2") str += "°C";
              const yoyIdx = context.dataIndex - 52;
              if (yoyIdx >= 0) {
                const yoyVal = context.dataset.data[yoyIdx];
                if (!isNaN(yoyVal)) str += " (去年: " + (+yoyVal).toFixed(2) + "°C)";
              }
              return str;
            }
          }
        }
      }
    }
  });
}

/***************************************************************
 * 8) D. 工具：取“最后一周值”
 ***************************************************************/
function getLatestValue(arr) {
  if (arr.length === 0) return NaN;
  return arr[arr.length - 1];
}

/***************************************************************
 * 9) E. 侧边栏渲染（同组内按“最后一周值”升序）
 ***************************************************************/
function renderGroupSidebar(gData) {
  const container = document.getElementById("groupContainer");
  const noMatchMsg = document.getElementById("noMatchMsg");
  container.innerHTML = "";
  noMatchMsg.style.display = "none";

  let totalGroups = 0;
  Object.keys(gData).forEach(grp => {
    totalGroups++;
    const details = document.createElement("details");
    details.className = "group-panel";
    details.open = true;

    // summary
    const summary = document.createElement("summary");
    const titleSpan = document.createElement("span");
    titleSpan.textContent = grp;
    const btnWrap = document.createElement("span");

    const allBtn = document.createElement("button");
    allBtn.textContent = "全选";
    allBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      setGroupCheck(grp, true);
    });

    const noneBtn = document.createElement("button");
    noneBtn.textContent = "全不选";
    noneBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      setGroupCheck(grp, false);
    });

    btnWrap.appendChild(allBtn);
    btnWrap.appendChild(noneBtn);
    summary.appendChild(titleSpan);
    summary.appendChild(btnWrap);
    details.appendChild(summary);

    // 关键词 → 先收集后排序
    const kwMap = gData[grp];
    let kwArray = Object.keys(kwMap).map(kw => {
      const arr = kwMap[kw];
      return { kw, latestVal: getLatestValue(arr), arr };
    });
    kwArray.sort((a, b) => {
      const A = a.latestVal, B = b.latestVal;
      const isANaN = isNaN(A), isBNaN = isNaN(B);
      if (isANaN && isBNaN) return a.kw.localeCompare(b.kw);
      if (isANaN) return 1;
      if (isBNaN) return -1;
      return A - B;
    });

    kwArray.forEach(obj => {
      const lb = document.createElement("label");
      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.checked = true;
      cb.dataset.group = grp;
      cb.dataset.keyword = obj.kw;
      lb.appendChild(cb);
      lb.append(" " + obj.kw + (isNaN(obj.latestVal) ? "" : " (" + obj.latestVal.toFixed(1) + ")"));
      details.appendChild(lb);
    });

    container.appendChild(details);
  });

  if (totalGroups === 0) {
    noMatchMsg.style.display = "";
  }

  container.addEventListener("change", (e) => {
    if (e.target.type === "checkbox") updateVisibleLines();
  });
}

/***************************************************************
 * 10) F. 搜索过滤
 ***************************************************************/
function applySearchFilter(term) {
  const noMatchMsg = document.getElementById("noMatchMsg");
  noMatchMsg.style.display = "none";

  const s = term.trim().toLowerCase();
  let visibleCount = 0;

  const groupPanels = document.querySelectorAll(".group-panel");
  groupPanels.forEach(panel => {
    const summary = panel.querySelector("summary");
    if (!summary) return;
    const grpName = summary.firstChild.textContent;
    const grpLower = grpName.toLowerCase();
    const labels = panel.querySelectorAll("label");

    let groupMatched = s.length > 0 && grpLower.includes(s);
    let matchedKw = 0;

    labels.forEach(lb => {
      const txt = lb.textContent.toLowerCase();
      const hit = (s.length === 0 || groupMatched || txt.includes(s));
      lb.style.display = hit ? "" : "none";
      if (hit) matchedKw++;
    });

    const show = (s.length === 0) ? true : (groupMatched || matchedKw > 0);
    panel.style.display = show ? "" : "none";
    if (show) visibleCount++;
  });

  if (visibleCount === 0) noMatchMsg.style.display = "";
}

/***************************************************************
 * 11) G. 构造数据集并绘图
 ***************************************************************/
function updateVisibleLines() {
  const cbs = document.querySelectorAll(`#groupContainer input[type='checkbox']:checked`);
  const dsList = [];
  let idx = 0;

  cbs.forEach(cb => {
    const grp = cb.dataset.group;
    const kw = cb.dataset.keyword;
    const arr = globalGroupsRaw[grp][kw]; // 使用原始数据
    dsList.push({
      label: grp + "/" + kw,
      data: arr,
      borderColor: colorAt(idx++),
      fill: false,
      tension: 0.25,
      pointRadius: 0,
      yAxisID: "y",
      borderWidth: 1.6
    });
  });
  createChart(labelsAll, dsList);
}

/***************************************************************
 * 12) H. 分组全选/全不选 & 全局全选/全不选
 ***************************************************************/
function setGroupCheck(groupName, isCheck) {
  const cbs = document.querySelectorAll(`#groupContainer input[data-group="${groupName}"]`);
  cbs.forEach(cb => cb.checked = isCheck);
  updateVisibleLines();
}
function setAllCheck(isCheck) {
  const cbs = document.querySelectorAll(`#groupContainer input[type='checkbox']`);
  cbs.forEach(cb => cb.checked = isCheck);
  updateVisibleLines();
}

/***************************************************************
 * 13) I. 时间区间过滤
 ***************************************************************/
function filterDataRange(startIdx, endIdx) {
  const s = Math.min(startIdx, endIdx);
  const e = Math.max(startIdx, endIdx);

  const cbs = document.querySelectorAll(`#groupContainer input[type='checkbox']:checked`);
  const dsList = [];
  let i = 0;
  cbs.forEach(cb => {
    const grp = cb.dataset.group;
    const kw = cb.dataset.keyword;
    const fullData = globalGroupsRaw[grp][kw];
    const sliced = fullData.slice(s, e + 1);
    dsList.push({
      label: grp + "/" + kw,
      data: sliced,
      borderColor: colorAt(i++),
      fill: false,
      tension: 0.25,
      pointRadius: 0,
      yAxisID: "y",
      borderWidth: 1.6
    });
  });

  const slicedWeeks = labelsAll.slice(s, e + 1);
  const slicedAvg = tempAvgData.slice(s, e + 1);
  const slicedMax = tempMaxData.slice(s, e + 1);

  createChart2(slicedWeeks, dsList, slicedAvg, slicedMax);
}

function createChart2(weeks, dsList, slicedAvg, slicedMax) {
  if (chart) chart.destroy();

  dsList.push({
    label: "平均气温",
    data: slicedAvg,
    borderColor: "rgba(99,162,255,.9)",
    borderWidth: 2,
    borderDash: [6, 3],
    fill: false,
    tension: 0.25,
    pointRadius: 0,
    yAxisID: "y2"
  });
  dsList.push({
    label: "最高气温",
    data: slicedMax,
    borderColor: "rgba(255,120,120,.95)",
    borderWidth: 2,
    borderDash: [6, 3],
    fill: false,
    tension: 0.25,
    pointRadius: 0,
    yAxisID: "y2"
  });

  const ctx = document.getElementById("myChart").getContext("2d");
  chart = new Chart(ctx, {
    type: "line",
    data: { labels: weeks, datasets: dsList },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      normalized: true,
      parsing: false,
      animation: false,
      interaction: { mode: 'index', intersect: false },
      elements: { line: { capBezierPoints: true } },
      scales: {
        x: {
          title: { display: true, text: "周" },
          grid: { color: 'rgba(255,255,255,0.08)' },
          ticks: { color: '#9ca3af', maxRotation: 0, autoSkip: true }
        },
        y: {
          reverse: true,
          title: { display: true, text: "关键词热度(数值小→上)" },
          grid: { color: 'rgba(255,255,255,0.08)' },
          ticks: { color: '#9ca3af' }
        },
        y2: {
          position: "right",
          reverse: false,
          title: { display: true, text: "气温(℃)" },
          grid: { drawOnChartArea: false },
          ticks: { color: '#9ca3af' }
        }
      },
      plugins: {
        legend: { labels: { font: { size: 12 }, boxWidth: 10, color: '#d1d5db' } },
        decimation: { enabled: true, algorithm: 'min-max', samples: 300 },
        tooltip: {
          titleFont: { size: 13 },
          bodyFont: { size: 12 },
          callbacks: {
            label: function (context) {
              const val = context.parsed.y;
              let str = context.dataset.label + ": " + val;
              if (context.dataset.yAxisID === "y2") str += "°C";
              const yoyIdx = context.dataIndex - 52;
              if (yoyIdx >= 0) {
                const yoyVal = context.dataset.data[yoyIdx];
                if (!isNaN(yoyVal)) str += " (去年: " + (+yoyVal).toFixed(2) + "°C)";
              }
              return str;
            }
          }
        }
      }
    }
  });
}

/***************************************************************
 * 14) J. 主流程
 ***************************************************************/
async function main() {
  // 1) 关键词
  const keywordRaw = await parseCSVWithRetry(KEYWORD_CSV_URL, 3);
  const longData = convertWideToLong(keywordRaw.data);
  const { weeks, groups } = processLongRows(longData);
  labelsAll = weeks;
  globalGroupsRaw = groups; // 原始数据保存
  groupsData = groups;      // 当前显示

  // 2) 平均气温
  const avgRaw = await parseCSVWithRetry(AVG_TEMP_CSV_URL, 3);
  const avgMap = convertTempData(avgRaw.data);

  // 3) 最高气温
  const maxRaw = await parseCSVWithRetry(MAX_TEMP_CSV_URL, 3);
  const maxMap = convertTempData(maxRaw.data);

  // 4) 对齐气温数据
  tempAvgData = new Array(labelsAll.length).fill(NaN);
  tempMaxData = new Array(labelsAll.length).fill(NaN);
  labelsAll.forEach((wk, i) => {
    if (avgMap[wk] != null) tempAvgData[i] = avgMap[wk];
    if (maxMap[wk] != null) tempMaxData[i] = maxMap[wk];
  });

  // 5) 渲染侧边栏
  renderGroupSidebar(groupsData);

  // 6) 初始化下拉
  const startSel = document.getElementById("startWeek");
  const endSel = document.getElementById("endWeek");
  weeks.forEach((wk, i) => {
    const t = wk.replace("_Week_", " W");
    startSel.add(new Option(t, i));
    endSel.add(new Option(t, i));
  });
  startSel.value = 0;
  endSel.value = weeks.length - 1;

  // 7) 默认全选
  updateVisibleLines();
}

/***************************************************************
 * 15) 事件绑定
 ***************************************************************/
document.getElementById("toggleSidebar").addEventListener("click", () => {
  const sb = document.getElementById("sidebar");
  sb.classList.toggle("hidden");
});
document.getElementById("btnRefresh").addEventListener("click", () => { main(); });
document.getElementById("btnFilter").addEventListener("click", () => {
  const s = parseInt(document.getElementById("startWeek").value);
  const e = parseInt(document.getElementById("endWeek").value);
  filterDataRange(Math.min(s,e), Math.max(s,e));
});
document.getElementById("globalAllBtn").addEventListener("click", () => { setAllCheck(true); });
document.getElementById("globalNoneBtn").addEventListener("click", () => { setAllCheck(false); });
document.getElementById("searchInput").addEventListener("input", (e) => { applySearchFilter(e.target.value); });
document.getElementById("btnClearSearch").addEventListener("click", () => {
  const inp = document.getElementById("searchInput"); inp.value = ""; applySearchFilter("");
});
document.addEventListener("DOMContentLoaded", () => { main(); });
</script>
</body>
</html>
