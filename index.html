<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>KeyWord热度 + 氣温 + 搜索</title>
  <!-- Papa Parse (解析CSV) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.2.1"></script>

  <style>
    html, body {
      margin: 0; 
      padding: 0;
      height: 100%;
      font-family: sans-serif;
      overflow: auto;
    }
    .sidebar-toggle {
      position: fixed; left:0; top:0; z-index:9999;
      background: #3b5998; color:#fff; padding:8px 12px; border:none;
      cursor:pointer;
    }
    .sidebar {
      position: fixed; left:0; top:0; width:280px; height:100vh; background:#fafafa;
      box-shadow: 2px 0 5px rgba(0,0,0,0.2);
      transform: translateX(-100%); transition: transform 0.3s; padding:10px;
      box-sizing:border-box; overflow-y:auto; z-index:9998;
    }
    .sidebar.active { transform:translateX(0); }
    .sidebar h3 {
      margin:0 0 6px; 
      display:flex; align-items:center; gap:4px;
    }
    .search-row {
      display:flex; align-items:center; gap:4px;
      margin-bottom:8px;
    }
    .search-row input {
      flex:1;
      padding:4px 6px;
      font-size:14px;
    }
    .search-row button {
      font-size:12px; cursor:pointer; padding:4px 8px;
    }
    .group-panel { margin-bottom:6px; border:1px solid #ccc; border-radius:4px; }
    summary {
      background:#eee; padding:4px 6px; font-weight:bold; cursor:pointer;
      display:flex; align-items:center; justify-content:space-between;
    }
    summary button {
      font-size:12px; cursor:pointer; margin-left:8px;
    }

    .main-area {
      margin-left:60px; display:flex; flex-direction:column; height:100vh;
    }
    .topbar {
      background:#f0f0f0; padding:8px; display:flex; align-items:center; gap:6px; flex-shrink:0;
    }
    .chart-container {
      flex:1; position:relative; overflow:auto;
    }
    #myChart {
      min-width:1200px; min-height:600px;
    }
  </style>
</head>

<body>
  <!-- 侧边栏按钮 -->
  <button class="sidebar-toggle" id="toggleSidebar">≡</button>

  <!-- 侧边栏 -->
  <div class="sidebar" id="sidebar">
    <h3>
      分组
      <button id="globalAllBtn">全选</button>
      <button id="globalNoneBtn">全不选</button>
    </h3>

    <!-- 搜索行 -->
    <div class="search-row">
      <input type="text" id="searchInput" placeholder="搜索分组或关键词...">
      <button id="btnClearSearch">X</button>
    </div>

    <div id="groupContainer"></div>
    <div id="noMatchMsg" style="display:none; color:#999; margin-top:8px;">
      未找到匹配项
    </div>
  </div>

  <div class="main-area">
    <div class="topbar">
      <h1 style="margin:0; flex:1;">KeyWord热度 + 氣温 + 搜索</h1>
      <button id="btnRefresh">刷新数据</button>
      <label>开始周:</label>
      <select id="startWeek"></select>
      <label>结束周:</label>
      <select id="endWeek"></select>
      <button id="btnFilter">更新区间</button>
    </div>
    <div class="chart-container">
      <canvas id="myChart"></canvas>
    </div>
  </div>

<script>
// 1) CSV 链接
const KEYWORD_CSV_URL = "...";
const AVG_TEMP_CSV_URL = "...";
const MAX_TEMP_CSV_URL = "...";

// 2) 全局变量
let chart;
let labelsAll=[];
let groupsData={};
let tempAvgData=[];
let tempMaxData=[];
let globalGroupsRaw={}; // 用于存储“原始的 groupsData”，以便搜索过滤

// ============ 侧边栏搜索 ============
// 当用户输入搜索内容时，会过滤“分组”与“关键词”名字
// 如果分组名本身匹配，就显示整个分组；否则只显示匹配的关键词；
// 如果一个分组下完全没有匹配的关键词，就不显示该分组。
function renderGroupSidebar(groups, searchTerm=""){
  const container= document.getElementById("groupContainer");
  const noMatchMsg= document.getElementById("noMatchMsg");
  container.innerHTML="";
  noMatchMsg.style.display="none";

  const s= searchTerm.trim().toLowerCase();
  let matchedCount=0;

  Object.keys(groups).forEach(grp=>{
    const grpLower= grp.toLowerCase();
    // 检查分组名是否匹配
    const groupMatched= s.length>0 && grpLower.includes(s);
    const kwMap= groups[grp];

    // 收集匹配关键词
    let matchedKeywords=[];
    Object.keys(kwMap).forEach(kw=>{
      const kwLower= kw.toLowerCase();
      if(groupMatched || (kwLower.includes(s))) {
        matchedKeywords.push(kw);
      }
    });

    if(s.length===0) {
      // 无搜索 => 显示所有关键词
      matchedKeywords= Object.keys(kwMap);
    }

    if(matchedKeywords.length>0){
      matchedCount++;
      // 创建 details
      const details= document.createElement("details");
      details.className="group-panel";

      // summary
      const summary= document.createElement("summary");
      summary.textContent= grp;
      details.appendChild(summary);

      matchedKeywords.forEach(kw=>{
        const lb= document.createElement("label");
        lb.style.display="block";
        const cb= document.createElement("input");
        cb.type="checkbox";
        cb.checked=true;
        cb.dataset.group=grp;
        cb.dataset.keyword=kw;

        lb.appendChild(cb);
        lb.append(" "+kw);
        details.appendChild(lb);
      });

      container.appendChild(details);
    }
  });

  if(matchedCount===0){
    noMatchMsg.style.display="";
  }

  // 重新绑定事件
  container.addEventListener("change",(e)=>{
    if(e.target.type==="checkbox") updateVisibleLines();
  });
}

// 3) updateVisibleLines
function updateVisibleLines(){
  const cbs= document.querySelectorAll(`#groupContainer input[type='checkbox']:checked`);
  const dsList=[];
  const colorList=[
    "#e6194b","#3cb44b","#ffe119","#0082c8","#f58231","#911eb4","#46f0f0",
    "#f032e6","#d2f53c","#fabebe","#008080","#e6beff","#aa6e28","#fffac8",
    "#800000","#aaffc3","#808000","#ffd8b1","#000080","#808080","#000000"
  ];
  let idx=0;
  cbs.forEach(cb=>{
    const grp= cb.dataset.group;
    const kw= cb.dataset.keyword;
    const arr= groupsData[grp][kw];
    dsList.push({
      label: grp+"/"+kw,
      data: arr,
      borderColor: colorList[idx%colorList.length],
      fill:false,
      tension:0.1,
      pointRadius:2,
      pointHoverRadius:6,
      yAxisID:"y"
    });
    idx++;
  });
  createChart(labelsAll, dsList);
}

// 4) createChart: 单图 + 双Y轴 + tooltip
function createChart(weeks, dsList){
  const ctx= document.getElementById("myChart").getContext("2d");
  if(chart) chart.destroy();

  // 把气温线加进去
  dsList.push({
    label:"平均气温",
    data: tempAvgData,
    borderColor:"rgba(0,0,255,0.7)",
    borderWidth:2,
    borderDash:[6,3],
    fill:false,
    tension:0.1,
    pointRadius:0,
    pointHoverRadius:6,
    yAxisID:"y2"
  });
  dsList.push({
    label:"最高气温",
    data: tempMaxData,
    borderColor:"rgba(255,0,0,0.7)",
    borderWidth:2,
    borderDash:[6,3],
    fill:false,
    tension:0.1,
    pointRadius:0,
    pointHoverRadius:6,
    yAxisID:"y2"
  });

  chart= new Chart(ctx, {
    type:"line",
    data:{ labels:weeks, datasets: dsList },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      interaction:{ mode:'index', intersect:false },
      scales:{
        x:{ title:{ display:true, text:"周" } },
        y:{
          reverse:true,
          title:{ display:true, text:"关键词热度(数值小→上)" }
        },
        y2:{
          position:"right",
          reverse:false,
          title:{ display:true, text:"气温(℃)" },
          grid:{ drawOnChartArea:false }
        }
      },
      plugins:{
        legend:{ labels:{ font:{ size:16 } } },
        tooltip:{
          titleFont:{ size:16 },
          bodyFont:{ size:16 },
          callbacks:{
            label: function(context){
              const val= context.parsed.y;
              let str= context.dataset.label + ": " + val;
              if(context.dataset.yAxisID==="y2"){
                str+= "°C";
              }
              // yoy
              const yoyIdx= context.dataIndex - 52;
              if(yoyIdx>=0){
                const yoyVal= context.dataset.data[yoyIdx];
                if(!isNaN(yoyVal)){
                  str+= " (去年: "+ yoyVal.toFixed(2)+"°C)";
                }
              }
              return str;
            }
          }
        }
      }
    }
  });
}

// 5) 过滤区间
function filterDataRange(startIdx, endIdx){
  const cbs= document.querySelectorAll(`#groupContainer input[type='checkbox']:checked`);
  const dsList=[];
  const colorList=[
    "#e6194b","#3cb44b","#ffe119","#0082c8","#f58231","#911eb4","#46f0f0",
    "#f032e6","#d2f53c","#fabebe","#008080","#e6beff","#aa6e28","#fffac8",
    "#800000","#aaffc3","#808000","#ffd8b1","#000080","#808080","#000000"
  ];
  let i=0;
  cbs.forEach(cb=>{
    const grp= cb.dataset.group;
    const kw= cb.dataset.keyword;
    const fullData= groupsData[grp][kw];
    const sliced= fullData.slice(startIdx,endIdx+1);
    dsList.push({
      label: grp+"/"+kw,
      data: sliced,
      borderColor: colorList[i%colorList.length],
      fill:false,
      tension:0.1,
      pointRadius:2,
      pointHoverRadius:6,
      yAxisID:"y"
    });
    i++;
  });
  const slicedWeeks= labelsAll.slice(startIdx,endIdx+1);
  const slicedAvg= tempAvgData.slice(startIdx,endIdx+1);
  const slicedMax= tempMaxData.slice(startIdx,endIdx+1);

  createChart2(slicedWeeks, dsList, slicedAvg, slicedMax);
}
function createChart2(weeks, dsList, slicedAvg, slicedMax){
  if(chart) chart.destroy();
  // 加入气温线
  dsList.push({
    label:"平均气温",
    data:slicedAvg,
    borderColor:"rgba(0,0,255,0.7)",
    borderWidth:2,
    borderDash:[6,3],
    fill:false,
    tension:0.1,
    pointRadius:0,
    pointHoverRadius:6,
    yAxisID:"y2"
  });
  dsList.push({
    label:"最高气温",
    data:slicedMax,
    borderColor:"rgba(255,0,0,0.7)",
    borderWidth:2,
    borderDash:[6,3],
    fill:false,
    tension:0.1,
    pointRadius:0,
    pointHoverRadius:6,
    yAxisID:"y2"
  });

  const ctx= document.getElementById("myChart").getContext("2d");
  chart= new Chart(ctx, {
    type:"line",
    data:{ labels: weeks, datasets: dsList },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      interaction:{ mode:'index', intersect:false },
      scales:{
        x:{ title:{ display:true, text:"周" } },
        y:{ reverse:true, title:{ display:true, text:"关键词热度(数值小→上)" } },
        y2:{ position:"right", reverse:false, title:{ display:true, text:"气温(℃)" }, grid:{ drawOnChartArea:false } }
      },
      plugins:{
        legend:{ labels:{ font:{ size:16 } } },
        tooltip:{
          titleFont:{ size:16 },
          bodyFont:{ size:16 },
          callbacks:{
            label: function(context){
              const val= context.parsed.y;
              let str= context.dataset.label + ": " + val;
              if(context.dataset.yAxisID==="y2"){
                str+= "°C";
              }
              const yoyIdx= context.dataIndex - 52;
              if(yoyIdx>=0){
                const yoyVal= context.dataset.data[yoyIdx];
                if(!isNaN(yoyVal)){
                  str+= " (去年: "+ yoyVal.toFixed(2)+"°C)";
                }
              }
              return str;
            }
          }
        }
      }
    }
  });
}

// 6) 主流程
async function main(){
  // 关键词
  const keywordRaw= await parseCSV(KEYWORD_CSV_URL);
  const longData= convertWideToLong(keywordRaw.data);
  const { weeks, groups }= processLongRows(longData);
  labelsAll= weeks;
  groupsData= groups;

  // 平均气温
  const avgRaw= await parseCSV(AVG_TEMP_CSV_URL);
  const avgMap= convertTempData(avgRaw.data);

  // 最高气温
  const maxRaw= await parseCSV(MAX_TEMP_CSV_URL);
  const maxMap= convertTempData(maxRaw.data);

  // 对齐
  tempAvgData= new Array(labelsAll.length).fill(NaN);
  tempMaxData= new Array(labelsAll.length).fill(NaN);
  labelsAll.forEach((wk,i)=>{
    if(avgMap[wk]!=null){
      tempAvgData[i]= avgMap[wk];
    }
    if(maxMap[wk]!=null){
      tempMaxData[i]= maxMap[wk];
    }
  });

  // 渲染侧边栏
  // 先存储到 globalGroupsRaw, 以便搜索时能还原
  globalGroupsRaw= groups;
  renderGroupSidebar(groups, "");

  // 初始化下拉
  const startSel= document.getElementById("startWeek");
  const endSel= document.getElementById("endWeek");
  weeks.forEach((wk,i)=>{
    const opt1= document.createElement("option");
    opt1.value=i;
    opt1.text= wk.replace("_Week_"," W");
    startSel.appendChild(opt1);

    const opt2= document.createElement("option");
    opt2.value=i;
    opt2.text= wk.replace("_Week_"," W");
    endSel.appendChild(opt2);
  });
  startSel.value=0;
  endSel.value= weeks.length-1;

  // 默认全选
  updateVisibleLines();
}

// 7) parseCSV
function parseCSV(url){
  return new Promise((resolve, reject)=>{
    Papa.parse(url, {
      download:true,
      complete: res => resolve(res),
      error: err => reject(err)
    });
  });
}

// 8) 事件
document.getElementById("toggleSidebar").addEventListener("click",()=>{
  document.getElementById("sidebar").classList.toggle("active");
});
document.getElementById("btnRefresh").addEventListener("click",()=>{
  main();
});
document.getElementById("btnFilter").addEventListener("click",()=>{
  const s= parseInt(document.getElementById("startWeek").value);
  const e= parseInt(document.getElementById("endWeek").value);
  const startIdx= Math.min(s,e);
  const endIdx= Math.max(s,e);
  filterDataRange(startIdx,endIdx);
});
document.getElementById("globalAllBtn").addEventListener("click",()=>{
  setAllCheck(true);
});
document.getElementById("globalNoneBtn").addEventListener("click",()=>{
  setAllCheck(false);
});

// 搜索框
document.getElementById("searchInput").addEventListener("input",(e)=>{
  const val= e.target.value;
  renderGroupSidebar(globalGroupsRaw, val);
});
document.getElementById("btnClearSearch").addEventListener("click",()=>{
  const inp= document.getElementById("searchInput");
  inp.value="";
  renderGroupSidebar(globalGroupsRaw, "");
});

// run on load
main();
</script>
</body>
</html>
