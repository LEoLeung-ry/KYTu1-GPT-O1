<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>关键词热度 & 氣温 (带调试日志)</title>
  <!-- Papa Parse (解析CSV) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.2.1"></script>
  <style>
    /* 重置默认样式 */
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0; 
      padding: 0;
      font-family: sans-serif;
      /* 允许滚动，避免第二图被挤出可视范围 */
      overflow: auto;
    }
    .container {
      display: flex;
      flex-direction: column;
      gap: 20px;
      padding: 10px;
    }
    .chart-box {
      width: 100%;
      min-height: 400px;
      position: relative;
    }
    .chart-box canvas {
      width: 100%;
      height: 100%;
    }
    h2 {
      margin: 0 0 8px 0;
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- 上图：关键词热度 -->
    <h2>关键词热度 (Y 轴反转)</h2>
    <div class="chart-box">
      <canvas id="chartKeywords"></canvas>
    </div>

    <!-- 下图：气温 (平均 & 最高) -->
    <h2>气温 (平均 & 最高)</h2>
    <div class="chart-box">
      <canvas id="chartTemp"></canvas>
    </div>
  </div>

<script>
/**************************************************************
 * 1) 配置你的 CSV 链接
 **************************************************************/
// 关键词数据 (宽表)
const KEYWORD_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTxT7pk3XLnPr87Fpq2Fii90bqh_R2jsCjO6e3dZkMLKmuw75ksYiuSce3DC7uUK5IXBEFmeKT1P7oJ/pub?output=csv";

// 平均气温
const AVG_TEMP_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQsIu0jYheUb5YE9-D0SwtL6FxkTjFwEgWaH56NdOyqYfNkcZLJGM2xp9T2wPLcF5lYFBZ3UCa7eiaj/pub?output=csv";

// 最高气温
const MAX_TEMP_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSnxZTyYhuMkeM0D0ystDYz2w0tQJZDN5yyxoy51Rl8yA23j-7nSm3gOC4SeAJnhB9_iHT_mTIVzZlR/pub?output=csv";


/**************************************************************
 * 2) 全局变量 (Chart.js 实例、数据存储)
 **************************************************************/
let chartKeywords;  // 上图(关键词)
let chartTemp;      // 下图(气温)


//////////////////////////////////////////////////////////////
//   A. 关键词图相关 (含调试打印)
//////////////////////////////////////////////////////////////

// A.1) 加载 & 解析 关键词CSV
async function loadKeywordData() {
  console.log("[DEBUG] loadKeywordData() start...");
  const rawResult = await parseCSV(KEYWORD_CSV);
  console.log("[DEBUG] KEYWORD_CSV parse result:", rawResult);

  // rawResult.data 是一个 2D 数组
  const longData = convertWideToLong(rawResult.data);
  console.log("[DEBUG] convertWideToLong => longData:", longData);

  const { weeks, groups } = processLongRows(longData);
  console.log("[DEBUG] processLongRows => weeks:", weeks);
  console.log("[DEBUG] processLongRows => groups:", groups);

  return { weeks, groups };
}

// A.2) 宽表 => 长表 (示例)
function convertWideToLong(raw2D) {
  // 第0行=分组, 第1行=关键字, 第2行起=week_label + 值
  // 你也可以根据自己的CSV结构修改
  console.log("[DEBUG] raw2D length:", raw2D.length);
  if (!raw2D || raw2D.length < 3) {
    console.warn("[WARN] raw2D行数小于3，可能数据不足！");
  }

  const rowGroup   = raw2D[0];
  const rowKeyword = raw2D[1];

  console.log("[DEBUG] rowGroup(第0行):", rowGroup);
  console.log("[DEBUG] rowKeyword(第1行):", rowKeyword);

  const out = [];
  for (let r = 2; r < raw2D.length; r++) {
    const row = raw2D[r];
    if (!row[0]) {
      console.log(`[DEBUG] row[${r}]第一列为空, 跳过`);
      continue;
    }
    const fileName = row[0]; // e.g. "2023_10_15-10_21_Week_0"
    for (let c = 1; c < row.length; c++) {
      const grp = rowGroup[c];
      const kw  = rowKeyword[c];
      const val = parseFloat(row[c] || 0);
      out.push({
        week_label: fileName,
        group: grp,
        keyword: kw,
        value: val
      });
    }
  }
  return out;
}

// A.3) 长表 => weeks + groupsData
function processLongRows(longData) {
  const setWeeks = new Set();
  longData.forEach(it => setWeeks.add(it.week_label));
  const weeks = Array.from(setWeeks).sort();

  const gData = {}; // { group => { keyword => [array], ... } }
  const count = weeks.length;

  longData.forEach(it => {
    const w = it.week_label;
    const g = it.group;
    const k = it.keyword;
    const v = it.value;
    if (!gData[g]) {
      gData[g] = {};
    }
    if (!gData[g][k]) {
      gData[g][k] = new Array(count).fill(NaN);
    }
    const idx = weeks.indexOf(w);
    gData[g][k][idx] = v;
  });

  // 排序 group & keyword
  const sorted = {};
  Object.keys(gData).sort().forEach(gName => {
    const kwMap = gData[gName];
    const sortedKwMap = {};
    Object.keys(kwMap).sort().forEach(kName => {
      sortedKwMap[kName] = kwMap[kName];
    });
    sorted[gName] = sortedKwMap;
  });

  return { weeks, groups: sorted };
}

// A.4) 构造关键词图 (Y 轴反转)
function createKeywordChart(weeks, groupsData) {
  console.log("[DEBUG] createKeywordChart => weeks.length:", weeks.length);
  console.log("[DEBUG] createKeywordChart => groupsData:", groupsData);

  const ctx = document.getElementById("chartKeywords").getContext("2d");
  if (chartKeywords) chartKeywords.destroy();

  // 构造 datasets
  const dsList = [];
  const colorList = [
    "red","blue","green","orange","purple","brown","teal","magenta",
    "#e6194b","#3cb44b","#ffe119","#0082c8","#f58231","#911eb4","#46f0f0",
    "#f032e6","#d2f53c","#fabebe","#008080","#e6beff","#aa6e28","#fffac8",
    "#800000","#aaffc3","#808000","#ffd8b1","#000080","#808080","#000000"
  ];
  let idx=0;
  Object.keys(groupsData).forEach(g => {
    const kwMap = groupsData[g];
    Object.keys(kwMap).forEach(k => {
      dsList.push({
        label: g + "/" + k,
        data: kwMap[k],
        borderColor: colorList[idx % colorList.length],
        fill: false,
        tension: 0.1,
        pointRadius: 2
      });
      idx++;
    });
  });

  console.log("[DEBUG] createKeywordChart => dsList:", dsList);

  chartKeywords = new Chart(ctx, {
    type: 'line',
    data: {
      labels: weeks,
      datasets: dsList
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: {
          title: { display: true, text: "周" }
        },
        y: {
          reverse: true, // 数值小在上
          title: { display: true, text: "热度(数值小→上)" }
        }
      }
    }
  });
}


//////////////////////////////////////////////////////////////
//   B. 氣温图相关 (平均 & 最高) (含调试打印)
//////////////////////////////////////////////////////////////

// B.1) 并行加载平均气温CSV + 最高气温CSV => 2条线
async function loadTempData() {
  console.log("[DEBUG] loadTempData() start...");
  const [avgRes, maxRes] = await Promise.all([
    parseCSV(AVG_TEMP_CSV),
    parseCSV(MAX_TEMP_CSV)
  ]);
  console.log("[DEBUG] AVG_TEMP_CSV parse:", avgRes);
  console.log("[DEBUG] MAX_TEMP_CSV parse:", maxRes);

  // 把它们各自解析成 { week_label => value } 结构
  const avgMap = convertTempCSV(avgRes.data, "AvgTemp");
  const maxMap = convertTempCSV(maxRes.data, "MaxTemp");
  console.log("[DEBUG] avgMap =>", avgMap);
  console.log("[DEBUG] maxMap =>", maxMap);

  // 合并所有周
  const allWeeks = new Set([...Object.keys(avgMap), ...Object.keys(maxMap)]);
  const sortedWeeks = Array.from(allWeeks).sort();
  console.log("[DEBUG] sortedWeeks =>", sortedWeeks);

  const avgData = [];
  const maxData = [];
  sortedWeeks.forEach(wk => {
    avgData.push(avgMap[wk] ?? NaN);
    maxData.push(maxMap[wk] ?? NaN);
  });

  console.log("[DEBUG] avgData =>", avgData);
  console.log("[DEBUG] maxData =>", maxData);

  return { weeks: sortedWeeks, avg: avgData, max: maxData };
}

// B.2) 解析气温CSV(示例：假设宽表第一行=标题, 后面行=week_label, value)
function convertTempCSV(raw2D, debugLabel) {
  console.log(`[DEBUG] convertTempCSV(${debugLabel}) => raw2D.length:`, raw2D.length);
  if (!raw2D || raw2D.length < 2) {
    console.warn(`[WARN] CSV(${debugLabel}) 行数不足, 可能没有数据！`);
  }

  // 跳过第一行(标题)
  const outMap = {};
  for (let r = 1; r < raw2D.length; r++) {
    const row = raw2D[r];
    if (!row[0]) {
      console.log(`[DEBUG] row[${r}]没有week_label,跳过 in ${debugLabel}`);
      continue;
    }
    const wk = row[0];
    const val= parseFloat(row[1] || 0);
    outMap[wk] = val;
  }
  return outMap;
}

// B.3) 构造氣温图 (2条线：平均 & 最高)
function createTempChart(weeks, avgData, maxData) {
  console.log("[DEBUG] createTempChart => weeks.length:", weeks.length);
  console.log("[DEBUG] avgData =>", avgData);
  console.log("[DEBUG] maxData =>", maxData);

  const ctx = document.getElementById("chartTemp").getContext("2d");
  if (chartTemp) chartTemp.destroy();

  const dsList = [
    {
      label: "平均气温",
      data: avgData,
      borderColor: "blue",
      fill: false,
      tension: 0.1
    },
    {
      label: "最高气温",
      data: maxData,
      borderColor: "red",
      fill: false,
      tension: 0.1
    }
  ];

  console.log("[DEBUG] createTempChart => dsList:", dsList);

  chartTemp = new Chart(ctx, {
    type: 'line',
    data: {
      labels: weeks,
      datasets: dsList
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: {
          title: { display:true, text: "周" }
        },
        y: {
          reverse: false,
          title: { display:true, text: "摄氏度(℃)" }
        }
      }
    }
  });
}


//////////////////////////////////////////////////////////////
//   C. 通用函数
//////////////////////////////////////////////////////////////
function parseCSV(url) {
  console.log("[DEBUG] parseCSV =>", url);
  return new Promise((resolve, reject) => {
    Papa.parse(url, {
      download: true,
      complete: res => {
        console.log("[DEBUG] parseCSV complete for:", url, "=> res:", res);
        resolve(res);
      },
      error: err => {
        console.error("[ERROR] parseCSV error for:", url, err);
        reject(err);
      }
    });
  });
}


//////////////////////////////////////////////////////////////
//   D. 主流程 (含调试打印)
//////////////////////////////////////////////////////////////
window.addEventListener("DOMContentLoaded", async () => {
  console.log("[DEBUG] DOMContentLoaded, start main flow...");

  // 1) 关键词图
  try {
    const { weeks, groups } = await loadKeywordData();
    console.log("[DEBUG] => createKeywordChart with weeks.size:", weeks.length);
    createKeywordChart(weeks, groups);
  } catch(e) {
    console.error("[ERROR] loadKeywordData failed:", e);
  }

  // 2) 氣温图
  try {
    const { weeks: w2, avg, max } = await loadTempData();
    console.log("[DEBUG] => createTempChart with weeks.size:", w2.length);
    createTempChart(w2, avg, max);
  } catch(e) {
    console.error("[ERROR] loadTempData failed:", e);
  }

  console.log("[DEBUG] main flow finished.");
});
</script>

</body>
</html>
