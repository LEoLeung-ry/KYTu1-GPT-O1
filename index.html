<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>关键词 & 气温对比 (Small Multiples)</title>
  <!-- 1. Papa Parse (解析CSV) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <!-- 2. Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.2.1"></script>
  <style>
    /* 页面基础样式，可自行调整 */
    body {
      margin: 0; padding: 0;
      font-family: sans-serif;
    }
    .container {
      display: flex;
      flex-direction: column;
      gap: 20px;
      padding: 10px;
    }
    .chart-box {
      width: 100%;
      min-height: 400px;
      position: relative;
    }
    .chart-box canvas {
      width: 100%;
      height: 100%;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- 上图：关键词热度 -->
    <h2>关键词热度 (Y 轴反转)</h2>
    <div class="chart-box">
      <canvas id="chartKeywords"></canvas>
    </div>

    <!-- 下图：气温 (平均 & 最高) -->
    <h2>气温 (平均 & 最高)</h2>
    <div class="chart-box">
      <canvas id="chartTemp"></canvas>
    </div>
  </div>

<script>
/**************************************************************
 * 1) 配置你的 CSV 链接
 **************************************************************/
const KEYWORD_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTxT7pk3XLnPr87Fpq2Fii90bqh_R2jsCjO6e3dZkMLKmuw75ksYiuSce3DC7uUK5IXBEFmeKT1P7oJ/pub?output=csv";
// 示例：关键词数据 (宽表)
// 你的情况可能是 week_label + group + keyword

const AVG_TEMP_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQsIu0jYheUb5YE9-D0SwtL6FxkTjFwEgWaH56NdOyqYfNkcZLJGM2xp9T2wPLcF5lYFBZ3UCa7eiaj/pub?output=csv";
// 示例：周平均气温 (宽表)

const MAX_TEMP_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSnxZTyYhuMkeM0D0ystDYz2w0tQJZDN5yyxoy51Rl8yA23j-7nSm3gOC4SeAJnhB9_iHT_mTIVzZlR/pub?output=csv";
// 示例：周最高气温 (宽表)


/**************************************************************
 * 2) 全局变量 (Chart.js 实例、数据存储)
 **************************************************************/
let chartKeywords;  // 上图(关键词)
let chartTemp;      // 下图(气温)

//////////////////////////////////////////////////////////////
//   A. 关键词图相关
//////////////////////////////////////////////////////////////

// A.1) 解析关键词CSV (宽表 => 长表 => Data)
async function loadKeywordData() {
  // 用 Papa Parse 下载并返回 2D数组
  const rawResult = await parseCSV(KEYWORD_CSV);
  // 你可以复用你已有的 "convertWideToLong"、"processLongRows" 等逻辑
  // 这里示例假设 "row[0]" = week_label, "row[1..]" = 各分组/keyword
  // 并转成: { weeks: [...], groupsData: { group => { keyword => [values], ... } } }
  const longData = convertWideToLong(rawResult.data); 
  const { weeks, groups } = processLongRows(longData);
  return { weeks, groups };
}

// A.2) 转换宽表 => 长表 (示例逻辑，可按你自己写)
function convertWideToLong(raw2D) {
  // raw2D是 Papa Parse 返回的 { data: [ [col0, col1, ...], ... ] }
  // 第0行=分组? 第1行=关键词? 第2行起= week_label + 值
  // 你可参照你已有的 convertWideToLong 代码
  const rowGroup   = raw2D[0];
  const rowKeyword = raw2D[1];
  const out = [];
  for (let r = 2; r < raw2D.length; r++) {
    const row = raw2D[r];
    const fileName = row[0]; // week_label
    for (let c = 1; c < row.length; c++) {
      const grp = rowGroup[c];
      const kw  = rowKeyword[c];
      const val = parseFloat(row[c] || 0);
      out.push({
        "week_label": fileName,
        group: grp,
        keyword: kw,
        value: val
      });
    }
  }
  return out;
}

// A.3) 长表 => { weeks:[], groupsData:{} }
function processLongRows(longData) {
  const setWeeks = new Set();
  longData.forEach(it => setWeeks.add(it.week_label));
  const weeks = Array.from(setWeeks).sort();

  const gData = {}; // { group => { keyword => [array of values], ... } }
  const count = weeks.length;

  longData.forEach(it => {
    const w = it.week_label;
    const g = it.group;
    const k = it.keyword;
    const v = it.value;
    if (!gData[g]) {
      gData[g] = {};
    }
    if (!gData[g][k]) {
      gData[g][k] = new Array(count).fill(NaN);
    }
    const idx = weeks.indexOf(w);
    gData[g][k][idx] = v;
  });
  // 排序 group, keyword
  const sorted = {};
  Object.keys(gData).sort().forEach(gName => {
    const kwMap = gData[gName];
    const sortedKwMap = {};
    Object.keys(kwMap).sort().forEach(kName => {
      sortedKwMap[kName] = kwMap[kName];
    });
    sorted[gName] = sortedKwMap;
  });
  return { weeks, groups: sorted };
}

// A.4) 构造关键词图
function createKeywordChart(weeks, groupsData) {
  const ctx = document.getElementById("chartKeywords").getContext("2d");
  if (chartKeywords) chartKeywords.destroy();

  // 简单起见，这里只画一部分 (比如 group=someGroup) 
  // 如果你想做分组勾选, 需更多UI. 这里演示固定把 "group+keyword" 全部画
  const dsList = [];
  const colorList = ["red","blue","green","orange","purple","brown","teal","magenta"];
  let idx=0;
  Object.keys(groupsData).forEach(g => {
    const kwMap = groupsData[g];
    Object.keys(kwMap).forEach(k => {
      dsList.push({
        label: g + "/" + k,
        data: kwMap[k],
        borderColor: colorList[idx % colorList.length],
        fill: false,
        tension: 0.1,
        pointRadius: 2
      });
      idx++;
    });
  });

  chartKeywords = new Chart(ctx, {
    type: 'line',
    data: {
      labels: weeks,
      datasets: dsList
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: {
          title: { display:true, text: "周" }
        },
        y: {
          reverse: true, // 关键词热度：数值小在上
          title: { display:true, text: "热度(数值小→上)" }
        }
      }
    }
  });
}


//////////////////////////////////////////////////////////////
//   B. 气温图相关
//////////////////////////////////////////////////////////////

// B.1) 加载“平均气温”和“最高气温”这两个 CSV，并合并到一起
async function loadTempData() {
  const [avgRes, maxRes] = await Promise.all([
    parseCSV(AVG_TEMP_CSV),
    parseCSV(MAX_TEMP_CSV)
  ]);
  // 假设这两个CSV都类似的宽表格式：第0行=都道府县/列名, 第1列= week_label ...
  // 你也可以跟关键词那边同样：0行=分组, 1行=keyword ...
  // 这里演示把 "AverageTemp" 和 "MaxTemp" 当作 2 条线, 仅 1 列, 不是多prefecture.
  // 如果你是每个都道府县一列，就需要像上面那样 parse -> processLongRows
  // 这里示例: each CSV => [ [week_label, val], ... ]
  // => unify by week_label

  // 简单写法： 先 convert each to an object { week_label => value }
  const avgMap = convertSimpleWide(avgRes.data, "AvgTemp");
  const maxMap = convertSimpleWide(maxRes.data, "MaxTemp");

  // unify all week_labels
  const allWeeks = new Set([...Object.keys(avgMap), ...Object.keys(maxMap)]);
  const sortedWeeks = Array.from(allWeeks).sort();

  // 构造2个 dataset
  const avgData = [];
  const maxData = [];
  sortedWeeks.forEach(wk => {
    avgData.push(avgMap[wk] ?? NaN);
    maxData.push(maxMap[wk] ?? NaN);
  });

  return { weeks: sortedWeeks, avg: avgData, max: maxData };
}

// B.2) 解析宽表(示例非常简化): row[0] = week_label, row[1] = temperature
function convertSimpleWide(raw2D, colName) {
  // 你得根据实际 CSV 结构写对应逻辑
  // 这里示例:  top row: ["week_label","Temperature"] 
  //           subsequent rows: ["2023_10_15-10_21_Week_0","18.3"] ...
  const outMap = {};
  // 跳过第0行(标题)
  for (let r = 1; r < raw2D.length; r++) {
    const row = raw2D[r];
    const wk = row[0];
    const val= parseFloat(row[1] || 0);
    outMap[wk] = val;
  }
  return outMap;
}

// B.3) 构造氣温图
function createTempChart(weeks, avgData, maxData) {
  const ctx = document.getElementById("chartTemp").getContext("2d");
  if (chartTemp) chartTemp.destroy();

  const dsList = [
    {
      label: "平均气温",
      data: avgData,
      borderColor: "blue",
      fill: false,
      tension: 0.1
    },
    {
      label: "最高气温",
      data: maxData,
      borderColor: "red",
      fill: false,
      tension: 0.1
    }
  ];

  chartTemp = new Chart(ctx, {
    type: 'line',
    data: {
      labels: weeks,
      datasets: dsList
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: {
          title: { display:true, text: "周" }
        },
        y: {
          reverse: false, // 气温: 正常, 数值小在下
          title: { display:true, text: "摄氏度(℃)" }
        }
      }
    }
  });
}


//////////////////////////////////////////////////////////////
//   C. 通用工具
//////////////////////////////////////////////////////////////

function parseCSV(url) {
  return new Promise((resolve, reject) => {
    Papa.parse(url, {
      download: true,
      complete: res => resolve(res),
      error: err => reject(err)
    });
  });
}


//////////////////////////////////////////////////////////////
//   D. 页面加载后，依次加载 & 画图
//////////////////////////////////////////////////////////////

window.addEventListener("DOMContentLoaded", async () => {
  // 1) 加载 & 画 关键词图
  const { weeks, groups } = await loadKeywordData();
  createKeywordChart(weeks, groups);

  // 2) 加载 & 画 气温图
  const { weeks: w2, avg, max } = await loadTempData();
  createTempChart(w2, avg, max);

  // 这时，你就有上下两个图了。
});
</script>

</body>
</html>
