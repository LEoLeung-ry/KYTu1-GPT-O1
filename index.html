<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>关键词热度 & 气温 (Small Multiples)</title>
  <!-- Papa Parse (解析CSV) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.2.1"></script>
  <style>
    /* 重置默认样式 */
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0; 
      padding: 0;
      font-family: sans-serif;
      /* 去掉 overflow:hidden，改为可滚动 */
      overflow: auto;
    }
    .container {
      display: flex;
      flex-direction: column;
      gap: 20px;
      padding: 10px;
    }
    .chart-box {
      width: 100%;
      min-height: 400px;
      position: relative;
    }
    .chart-box canvas {
      width: 100%;
      height: 100%;
    }
    h2 {
      margin: 0 0 8px 0;
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- 上图：关键词热度 -->
    <h2>关键词热度 (Y 轴反转)</h2>
    <div class="chart-box">
      <canvas id="chartKeywords"></canvas>
    </div>

    <!-- 下图：气温 (平均 & 最高) -->
    <h2>气温 (平均 & 最高)</h2>
    <div class="chart-box">
      <canvas id="chartTemp"></canvas>
    </div>
  </div>

<script>
/**************************************************************
 * 1) 配置你的 CSV 链接
 **************************************************************/
// 关键词数据 (宽表)
const KEYWORD_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTxT7pk3XLnPr87Fpq2Fii90bqh_R2jsCjO6e3dZkMLKmuw75ksYiuSce3DC7uUK5IXBEFmeKT1P7oJ/pub?output=csv";

// 平均气温
const AVG_TEMP_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQsIu0jYheUb5YE9-D0SwtL6FxkTjFwEgWaH56NdOyqYfNkcZLJGM2xp9T2wPLcF5lYFBZ3UCa7eiaj/pub?output=csv";

// 最高气温
const MAX_TEMP_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSnxZTyYhuMkeM0D0ystDYz2w0tQJZDN5yyxoy51Rl8yA23j-7nSm3gOC4SeAJnhB9_iHT_mTIVzZlR/pub?output=csv";


/**************************************************************
 * 2) 全局变量 (Chart.js 实例、数据存储)
 **************************************************************/
let chartKeywords;  // 上图(关键词)
let chartTemp;      // 下图(气温)


//////////////////////////////////////////////////////////////
//   A. 关键词图相关
//////////////////////////////////////////////////////////////

// A.1) 加载 & 解析 关键词CSV
async function loadKeywordData() {
  const rawResult = await parseCSV(KEYWORD_CSV);
  // rawResult.data 是一个 2D 数组
  const longData = convertWideToLong(rawResult.data);
  const { weeks, groups } = processLongRows(longData);
  return { weeks, groups };
}

// A.2) 宽表 => 长表 (示例)
function convertWideToLong(raw2D) {
  // 第0行=分组, 第1行=关键字, 第2行起=week_label + 值
  // 你也可以根据自己的CSV结构修改
  const rowGroup   = raw2D[0];
  const rowKeyword = raw2D[1];

  const out = [];
  for (let r = 2; r < raw2D.length; r++) {
    const row = raw2D[r];
    if (!row[0]) continue; // 跳过空行
    const fileName = row[0]; // e.g. "2023_10_15-10_21_Week_0"
    for (let c = 1; c < row.length; c++) {
      const grp = rowGroup[c];
      const kw  = rowKeyword[c];
      const val = parseFloat(row[c] || 0);
      out.push({
        week_label: fileName,
        group: grp,
        keyword: kw,
        value: val
      });
    }
  }
  return out;
}

// A.3) 长表 => weeks + groupsData
function processLongRows(longData) {
  const setWeeks = new Set();
  longData.forEach(it => setWeeks.add(it.week_label));
  const weeks = Array.from(setWeeks).sort();

  const gData = {}; // { group => { keyword => [array], ... } }
  const count = weeks.length;

  longData.forEach(it => {
    const w = it.week_label;
    const g = it.group;
    const k = it.keyword;
    const v = it.value;
    if (!gData[g]) {
      gData[g] = {};
    }
    if (!gData[g][k]) {
      gData[g][k] = new Array(count).fill(NaN);
    }
    const idx = weeks.indexOf(w);
    gData[g][k][idx] = v;
  });

  // 排序 group & keyword
  const sorted = {};
  Object.keys(gData).sort().forEach(gName => {
    const kwMap = gData[gName];
    const sortedKwMap = {};
    Object.keys(kwMap).sort().forEach(kName => {
      sortedKwMap[kName] = kwMap[kName];
    });
    sorted[gName] = sortedKwMap;
  });

  return { weeks, groups: sorted };
}

// A.4) 构造关键词图 (Y 轴反转)
function createKeywordChart(weeks, groupsData) {
  const ctx = document.getElementById("chartKeywords").getContext("2d");
  if (chartKeywords) chartKeywords.destroy();

  // 构造 datasets
  const dsList = [];
  const colorList = ["red","blue","green","orange","purple","brown","teal","magenta",
                     "#e6194b","#3cb44b","#ffe119","#0082c8","#f58231","#911eb4","#46f0f0",
                     "#f032e6","#d2f53c","#fabebe","#008080","#e6beff","#aa6e28","#fffac8",
                     "#800000","#aaffc3","#808000","#ffd8b1","#000080","#808080","#000000"];
  let idx=0;
  Object.keys(groupsData).forEach(g => {
    const kwMap = groupsData[g];
    Object.keys(kwMap).forEach(k => {
      dsList.push({
        label: g + "/" + k,
        data: kwMap[k],
        borderColor: colorList[idx % colorList.length],
        fill: false,
        tension: 0.1,
        pointRadius: 2
      });
      idx++;
    });
  });

  chartKeywords = new Chart(ctx, {
    type: 'line',
    data: {
      labels: weeks,
      datasets: dsList
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: {
          title: { display: true, text: "周" }
        },
        y: {
          reverse: true, // 数值小在上
          title: { display: true, text: "热度(数值小→上)" }
        }
      }
    }
  });
}


//////////////////////////////////////////////////////////////
//   B. 氣温图相关 (平均 & 最高)
//////////////////////////////////////////////////////////////

// B.1) 并行加载平均气温CSV + 最高气温CSV => 2条线
async function loadTempData() {
  const [avgRes, maxRes] = await Promise.all([
    parseCSV(AVG_TEMP_CSV),
    parseCSV(MAX_TEMP_CSV)
  ]);

  // 把它们各自解析成 { week_label => value } 结构
  const avgMap = convertTempCSV(avgRes.data);
  const maxMap = convertTempCSV(maxRes.data);

  // 合并所有周
  const allWeeks = new Set([...Object.keys(avgMap), ...Object.keys(maxMap)]);
  const sortedWeeks = Array.from(allWeeks).sort();

  const avgData = [];
  const maxData = [];
  sortedWeeks.forEach(wk => {
    avgData.push(avgMap[wk] ?? NaN);
    maxData.push(maxMap[wk] ?? NaN);
  });

  return { weeks: sortedWeeks, avg: avgData, max: maxData };
}

// B.2) 解析气温CSV(示例：假设宽表第一行=标题, 后面行=week_label, value)
function convertTempCSV(raw2D) {
  // 跳过第一行(标题)
  const outMap = {};
  for (let r = 1; r < raw2D.length; r++) {
    const row = raw2D[r];
    if (!row[0]) continue;
    const wk = row[0];
    const val= parseFloat(row[1] || 0);
    outMap[wk] = val;
  }
  return outMap;
}

// B.3) 构造氣温图 (2条线：平均 & 最高)
function createTempChart(weeks, avgData, maxData) {
  const ctx = document.getElementById("chartTemp").getContext("2d");
  if (chartTemp) chartTemp.destroy();

  const dsList = [
    {
      label: "平均气温",
      data: avgData,
      borderColor: "blue",
      fill: false,
      tension: 0.1
    },
    {
      label: "最高气温",
      data: maxData,
      borderColor: "red",
      fill: false,
      tension: 0.1
    }
  ];

  chartTemp = new Chart(ctx, {
    type: 'line',
    data: {
      labels: weeks,
      datasets: dsList
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: {
          title: { display:true, text: "周" }
        },
        y: {
          reverse: false,
          title: { display:true, text: "摄氏度(℃)" }
        }
      }
    }
  });
}


//////////////////////////////////////////////////////////////
//   C. 通用函数
//////////////////////////////////////////////////////////////
function parseCSV(url) {
  return new Promise((resolve, reject) => {
    Papa.parse(url, {
      download: true,
      complete: res => resolve(res),
      error: err => reject(err)
    });
  });
}


//////////////////////////////////////////////////////////////
//   D. 主流程
//////////////////////////////////////////////////////////////
window.addEventListener("DOMContentLoaded", async () => {
  // 1) 关键词图
  const { weeks, groups } = await loadKeywordData();
  createKeywordChart(weeks, groups);

  // 2) 氣温图
  const { weeks: w2, avg, max } = await loadTempData();
  createTempChart(w2, avg, max);

  // 完成后，你就能在 GitHub Pages 打开此页面，看到上下两个图
});
</script>

</body>
</html>
